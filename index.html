<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Visitor Parking</title>

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;700;800&display=swap" rel="stylesheet">
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<link rel="dns-prefetch" href="//cdn.jsdelivr.net">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
*{ box-sizing: border-box; }

body{
  margin:0;
  font-family: Arial, sans-serif;
  background:#e9f5e9;
  text-transform: uppercase;
  padding: 0 20px 70px 20px;
}

/* ===== Fixed Header (Sensory-like) ===== */
.fixed-header{
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  background: #e9f5e9;
  z-index: 9999;
  padding: 14px 0 10px 0;
  box-shadow: 0 2px 8px rgba(0,0,0,.08);
}
.header-inner{
  max-width: 420px;
  margin: 0 auto;
  text-align: center;
  padding: 0 20px;
}
.clock-bar{
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
  max-width: 180px;
  margin: 0 auto 10px auto;
  padding: 2.5px 12px;
  border-radius: 11px;
  background: linear-gradient(90deg, #41e671 0%, #176B39 100%);
  box-shadow: 0 1px 4px 0 #bbdfbb70;
  font-size: 11px;
  color: #fff;
  letter-spacing: 1.4px;
  font-family: Arial, sans-serif;
  font-weight: bold;
  opacity: 0.90;
  position: relative;
  z-index: 10;
}
.clock-date, .clock-time{ font-size: 11px; }

.header-gradient{
  font-family: 'Orbitron', Arial, sans-serif;
  background: linear-gradient(145deg, #54e087 0%, #2b7a2b 100%);
  font-weight: 900;
  font-size: 1.6rem;
  letter-spacing: 1.3px;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  color: transparent;
}
.header-line{
  height:3px;
  width:60px;
  margin:0 auto 4px auto;
  background:linear-gradient(90deg,#3bd97b 20%,#2b7a2b 80%);
  border-radius:2px;
}


/* ===== SweetAlert2 (match Sensory) ===== */
.swal2-popup{
  width: 300px !important;
  max-width: 300px !important;
  padding: 14px 16px !important;
  border-radius: 14px !important;
}
.swal2-title{
  margin: 0 0 6px 0 !important;
  font-size: 16px !important;
  font-weight: 900 !important;
  letter-spacing: 1.2px !important;
}
.swal2-html-container{
  margin: 0 !important;
  font-size: 13px !important;
  font-weight: bold !important;
  line-height: 1.35 !important;
  letter-spacing: 0.7px !important;
}
.swal2-actions{
  margin: 12px 0 0 0 !important;
  gap: 10px;
}
.swal2-confirm{
  background: linear-gradient(135deg, #2b7a2b 0%, #3bd97b 100%) !important;
  color:#fff !important;
  font-weight:bold !important;
  border:none !important;
  border-radius:10px !important;
  box-shadow: 0 3px 12px 0 #bbdfbb, 0 1.5px 3px #3333 !important;
  letter-spacing: 1.6px;
  padding: 10px 22px !important;
  font-size: 14px !important;
  transition: box-shadow 0.16s, transform 0.09s;
}
.swal2-confirm:active{
  box-shadow: 0 2px 5px #bbb !important;
  transform: translateY(2px);
}
.swal2-cancel{
  background: linear-gradient(135deg, #e52d27 0%, #ff5757 100%) !important;
  color:#fff !important;
  font-weight:bold !important;
  border:none !important;
  border-radius:10px !important;
  box-shadow: 0 3px 10px #ffd2d2b9, 0 1.5px 3px #3333 !important;
  letter-spacing: 1.6px;
  padding: 10px 22px !important;
  font-size: 14px !important;
  margin-left: 0 !important;
  transition: box-shadow 0.16s, transform 0.09s;
}
.swal2-cancel:active{
  box-shadow: 0 2px 6px #d8b !important;
  transform: translateY(2px);
}

/* ===== SweetAlert2 (VPMS Grid Popup tweaks) ===== */
.vpms-swal .swal2-icon{ display:none !important; }
.vpms-swal .swal2-title{ font-size: 18px !important; }

/* input inside swal (match form input) */
.sw-reg-label{
  display:block;
  margin: 10px 0 4px 0;
  color:#2b7a2b;
  font-weight:900;
  font-size:13px;
  letter-spacing:.6px;
  text-align:left;
}
.sw-reg-input{
  width:100%;
  padding: 7px 9px;
  border: 1px solid #2b7a2b;
  border-radius: 8px;
  text-transform: uppercase;
  background-color: #e9f7ff;
  font-family: Arial, sans-serif;
  font-size: 13px;
  font-weight: bold;
  outline:none;
}


/* ===== Buttons (Sensory-like) ===== */
.btn-3d{
  background: linear-gradient(145deg, #3bd97b 0%, #2b7a2b 100%);
  color: #fff;
  border: none;
  border-radius: 10px;
  font-size: 14px;
  font-weight: bold;
  padding: 10px 22px;
  box-shadow: 0 3px 12px 0 #bbdfbb, 0 1.5px 3px #3333;
  letter-spacing: 1.6px;
  cursor: pointer;
  transition: box-shadow 0.18s, transform 0.1s;
}
.btn-3d:active{
  box-shadow: 0 2px 5px #bbb;
  transform: translateY(2px);
}

/* ===== Card/Form area ===== */
.card{
  max-width: 420px;
  margin: 18px auto 22px auto;
  background: #fff;
  border-radius: 13px;
  box-shadow: 0 2px 8px #176b3917;
  padding: 12px 15px 16px 15px;
}

label{
  display:block;
  margin-top:10px;
  color:#2b7a2b;
  font-weight:bold;
  font-size:13px;
}

select, input{
  width:100%;
  padding: 7px 9px;
  margin-top: 4px;
  border: 1px solid #2b7a2b;
  border-radius: 8px;
  text-transform: uppercase;
  background-color: #e9f7ff;
  font-family: Arial, sans-serif;
  font-size: 13px;
  font-weight: bold;
  outline:none;
}

select:invalid,
select option[value=""]{
  color:#888888 !important;
}

.lot-nav{
  display:flex;
  gap:10px;
  align-items:center;
  margin-top: 4px;
}
.navbtn{
  width:56px;
  padding: 10px 0;
  font-size:16px;
}

.navbtn:disabled{ opacity:.55; cursor:not-allowed; }
input:disabled{ opacity:.65; }

.lot-display.lot-display{
  flex:1;
  text-align:center;
  padding: 10px 0;
  border-radius: 8px;
  border: 1.5px solid #176B39;
  font-size: 15px;
  font-weight: bold;
  background: #f6fff6;
  color: #176B39;
  letter-spacing: 1.2px;
}

.hint{
  margin-top: 10px;
  text-align:center;
  font-size:12px;
  color:#666;
  font-weight: bold;
  letter-spacing: .6px;
}

.submit-3d{
  margin-top: 14px;
  width: 100%;
}

.status{
  text-align:center;
  margin-top: 10px;
  font-size: 13px;
  font-weight: bold;
  line-height: 1.35;
  letter-spacing: .7px;
}

/* ===== Fixed Footer ===== */
.footer{
  position: fixed;
  bottom: 8px;
  left: 0;
  width: 100%;
  text-align: center;
  font-size: 10px;
  color: #9aa9a0;
  font-family: Arial, sans-serif;
  font-weight: bold;
  pointer-events: none;
}

/* ===== Parking Grid ===== */
.gv-live-box{
  margin-top: 12px;
  padding: 12px 12px 10px;
  border-radius: 16px;
  background: linear-gradient(145deg,#ffffff,#e3f3e6);
  box-shadow: 0 6px 14px rgba(0,0,0,.10), inset 0 1px 0 rgba(255,255,255,.7);
  border: 1px solid rgba(23,107,57,.15);
  display:none; /* hidden until zone selected */
}
.gv-live-title{
  font-size: 11px;
  font-weight: 900;
  letter-spacing: 1.2px;
  color: #176B39;
  text-align: center;
  margin: 2px 0 10px;
}
.gv-grid{
  display: grid;
  grid-template-columns: repeat(var(--gv-cols, 3), 1fr);
  grid-template-rows: repeat(var(--gv-rows, 11), minmax(38px, auto));
  grid-auto-flow: column;
  gap: 8px;
}
.gv-slot{
  border-radius: 10px;
  padding: 6px 4px 5px;
  text-align: center;
  background: #f3fff6;
  border: 1px solid rgba(23,107,57,.18);
  box-shadow: inset 0 1px 0 rgba(255,255,255,.8);
  min-height: 38px;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
}
.gv-slot .gv-no{
  font-size: 10px;
  font-weight: 900;
  color: #176B39;
  letter-spacing: .4px;
  line-height: 1.05;
}
.gv-slot .gv-reg{
  margin-top: 3px;
  font-size: 9px;
  font-weight: 900;
  color: #3c6f53;
  letter-spacing: .4px;
  line-height: 1.05;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.gv-slot.is-empty .gv-reg{ opacity: .35; }
.gv-slot.is-active{
  border: 2px solid rgba(65,230,113,.95);
  box-shadow: 0 0 0 3px rgba(65,230,113,.18);
  background: #ecfff1;
}
</style>
</head>

<body>

<div class="fixed-header">
  <div class="header-inner">
    <div class="clock-bar">
      <span id="liveDateOnly" class="clock-date"></span>
      <span id="liveTimeOnly" class="clock-time"></span>
    </div>

    <div style="text-align:center;margin-bottom:8px;">
      <h2 class="header-gradient" style="margin:0 0 0.18em 0;">VISITOR PARKING</h2>
      <div style="color:#489167;font-size:13px;letter-spacing:0.6px;margin-bottom:6px;">VPMS</div>
    </div>

    <div class="header-line"></div>
  </div>
</div>

<div class="card">

  <label>PATROLLING TIME</label>
  <select id="round" required>
    <option value="" disabled selected>-PLEASE SELECT-</option>
    <option>08:00 AM</option>
    <option>11:00 AM</option>
    <option>02:00 PM</option>
    <option>05:00 PM</option>
    <option>08:00 PM</option>
    <option>11:00 PM</option>
    <option>02:00 AM</option>
    <option>05:00 AM</option>
  </select>

  <label>PARKING LIST</label>
  <select id="zoneSelect" required>
    <option value="" disabled selected>-PLEASE SELECT-</option>
    <option value="GV">GROUND VISITOR (GV01-GV33)</option>
    <option value="P8Z1">P8 ZONE 1 (P8-001-P8-015)</option>
    <option value="P8Z2">P8 ZONE 2 (P8-046-P8-089)</option>
    <option value="P8Z3">P8 ZONE 3 (P8-115-P8-140)</option>
    <option value="P8Z4">P8 ZONE 4 (P8-150-P8-167)</option>
    <option value="P8Z5">P8 ZONE 5 (P8-193-P8-208)</option>
    <option value="P8Z6">P8 ZONE 6 (P8-223-P8-239)</option>
    <option value="P8Z7">P8 ZONE 7 (P8-265-P8-279)</option>
  </select>

  <label>LOT</label>
  <div class="lot-nav">
    <button type="button" class="btn-3d navbtn" onclick="prevLot()">◀</button>
    <div class="lot-display" id="lotDisplay">GV01</div>
    <button type="button" class="btn-3d navbtn" onclick="nextLot()">▶</button>
  </div>

  <label>REG NUM</label>
  <input id="regInput" placeholder="" autocomplete="off" inputmode="text" />

  <div class="hint" id="hintText">LOT GV01 / 33</div>

  <div id="gvLiveBox" class="gv-live-box" aria-label="Parking Live List">
    <div class="gv-live-title" id="parkingListTitle">PARKING LIST</div>
    <div id="gvGrid" class="gv-grid"></div>
  </div>

  <button class="btn-3d submit-3d" type="button" onclick="submitAll()">SUBMIT ALL</button>

  <div class="status" id="status"></div>
</div>

<div class="footer">POWERED BY MRED TECH</div>

<script>
/* =========================
   VPMS — Visitor Parking (Production Clean)
   - Keep existing features & behavior
   - Grid hidden until zone selected
   - Grid click opens Sensory-style SweetAlert2 popup (REG NUM)
========================= */
(() => {
  "use strict";

  /* =========================
     CONFIG
  ========================= */
  const WORKER_URL = "https://PASTE-YOUR-WORKER-URL-HERE"; // <-- WAJIB tukar

  const ZONES = {
    GV:   { label: "GROUND VISITOR", type: "GV", start: 1,   end: 33  },
    P8Z1: { label: "P8 ZONE 1",      type: "P8", start: 1,   end: 15  },
    P8Z2: { label: "P8 ZONE 2",      type: "P8", start: 46,  end: 89  },
    P8Z3: { label: "P8 ZONE 3",      type: "P8", start: 115, end: 140 },
    P8Z4: { label: "P8 ZONE 4",      type: "P8", start: 150, end: 167 },
    P8Z5: { label: "P8 ZONE 5",      type: "P8", start: 193, end: 208 },
    P8Z6: { label: "P8 ZONE 6",      type: "P8", start: 223, end: 239 },
    P8Z7: { label: "P8 ZONE 7",      type: "P8", start: 265, end: 279 }
  };

  /* =========================
     DOM REFS
  ========================= */
  const liveDateOnly = document.getElementById("liveDateOnly");
  const liveTimeOnly = document.getElementById("liveTimeOnly");

  const roundSelect = document.getElementById("round");
  const zoneSelect  = document.getElementById("zoneSelect");

  const regInput   = document.getElementById("regInput");
  const navBtns   = document.querySelectorAll(".lot-nav .navbtn");
  const lotDisplay = document.getElementById("lotDisplay");
  const hintText   = document.getElementById("hintText");
  const statusBox  = document.getElementById("status");

  const gvLiveBox  = document.getElementById("gvLiveBox");
  const gvGrid     = document.getElementById("gvGrid");
  const gvTitle    = document.getElementById("parkingListTitle");

  /* =========================
     STATE
  ========================= */
  let zoneKey = "GV";
  let totalLots = 33;
  let lotIndex = 1;

  // plates keyed by lot string (e.g., GV01, P8-001)
  const plates = Object.create(null);

  // grid slot cache
  let gvSlots = Object.create(null);

  /* =========================
     HELPERS
  ========================= */
  const pad2 = (n) => (n < 10 ? "0" + n : "" + n);

  function normalizePlate(v) {
    return (v || "")
      .toUpperCase()
      .replace(/[^A-Z0-9]/g, "");
  }

  function safeSwalFire(options) {
    if (typeof Swal !== "undefined") return Swal.fire(options);
    // fallback: basic alert/confirm
    alert((options.title || "NOTICE") + "\n\n" + (options.text || ""));
    return Promise.resolve({ isConfirmed: true, value: "" });
  }

  function zoneObj() { return ZONES[zoneKey]; }

  function lotId(i) {
    const z = zoneObj();
    const num = z.start + (i - 1);
    if (z.type === "GV") return `GV${String(num).padStart(2, "0")}`;
    return `P8-${String(num).padStart(3, "0")}`;
  }

  function zoneRangeText() {
    const first = lotId(1);
    const last = lotId(totalLots);
    return `${first}-${last}`;
  }

  function setInputsEnabled(enabled) {
    if (navBtns && navBtns.length) navBtns.forEach(b => (b.disabled = !enabled));
    if (regInput) regInput.disabled = !enabled;
  }

  function clearActiveLot() {
    for (const k in gvSlots) gvSlots[k].classList.remove("is-active");
  }

  function renderLotPlaceholder() {
    if (lotDisplay) lotDisplay.textContent = "-PLEASE SELECT PARKING LOT-";
    if (regInput) regInput.value = "";
    if (hintText) hintText.textContent = "";
    clearActiveLot();
    setInputsEnabled(false);
  }

  /* =========================
     HEADER: DATETIME BAR
  ========================= */
  function updateDateTime() {
    const now = new Date();
    const d = pad2(now.getDate());
    const m = pad2(now.getMonth() + 1);
    const y = now.getFullYear();
    const h = pad2(now.getHours());
    const min = pad2(now.getMinutes());
    const s = pad2(now.getSeconds());

    if (liveDateOnly) liveDateOnly.textContent = `${d}/${m}/${y}`;
    if (liveTimeOnly) liveTimeOnly.textContent = `${h}:${min}:${s}`;
  }
  updateDateTime();
  setInterval(updateDateTime, 1000);

  /* =========================
     AUDIO: BEEP + VIBRATE
  ========================= */
  let audioCtx = null;

  function ensureAudio() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === "suspended") audioCtx.resume().catch(() => {});
  }

  function beep() {
    try {
      ensureAudio();
      if (!audioCtx) return;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = "square";
      o.frequency.value = 880;
      g.gain.value = 0.08;
      o.connect(g);
      g.connect(audioCtx.destination);
      o.start();
      o.stop(audioCtx.currentTime + 0.06);
    } catch (_) {}
  }

  function vibrate() {
    if (navigator.vibrate) navigator.vibrate(50);
  }

  document.addEventListener("click", ensureAudio, { once: true });
  document.addEventListener("touchstart", ensureAudio, { once: true, passive: true });

  /* =========================
     GRID RENDER
  ========================= */
  function setActiveLot(lot) {
    for (const k in gvSlots) {
      gvSlots[k].classList.toggle("is-active", k === lot);
    }
  }

  function renderSlot(lot) {
    const el = gvSlots[lot];
    if (!el) return;

    const regEl = el.querySelector(".gv-reg");
    const v = (plates[lot] || "").trim();

    if (v) {
      el.classList.remove("is-empty");
      regEl.textContent = v;
    } else {
      el.classList.add("is-empty");
      regEl.textContent = "-";
    }
  }

  function renderAllSlots() {
    for (const k in gvSlots) renderSlot(k);
  }

  function buildGrid() {
    if (!gvGrid) return;

    gvGrid.innerHTML = "";
    gvSlots = Object.create(null);

    const rows = Math.ceil(totalLots / 3);
    gvGrid.style.setProperty("--gv-cols", "3");
    gvGrid.style.setProperty("--gv-rows", String(rows));

    const frag = document.createDocumentFragment();

    for (let i = 1; i <= totalLots; i++) {
      const lot = lotId(i);

      const slot = document.createElement("div");
      slot.className = "gv-slot is-empty";
      slot.dataset.lot = lot;

      const no = document.createElement("div");
      no.className = "gv-no";
      no.textContent = lot;

      const reg = document.createElement("div");
      reg.className = "gv-reg";
      reg.textContent = "-";

      slot.appendChild(no);
      slot.appendChild(reg);

      // click -> popup
      slot.addEventListener("click", () => openGridPopup(lot));

      gvSlots[lot] = slot;
      frag.appendChild(slot);
    }

    gvGrid.appendChild(frag);
    if (gvTitle) gvTitle.textContent = `PARKING LIST (${zoneRangeText()})`;
  }

  /* =========================
     LOT INPUT / NAV
  ========================= */
  function renderLot() {
    setInputsEnabled(true);
    const lot = lotId(lotIndex);
    if (lotDisplay) lotDisplay.textContent = lot;
    if (regInput) regInput.value = plates[lot] || "";
    if (hintText) hintText.textContent = `LOT ${lot} / ${totalLots}`;

    setActiveLot(lot);
    renderSlot(lot);

    // keep existing behavior: focus input when lot changes
    if (regInput) regInput.focus();
  }

  function persistCurrentLotInput() {
    const lot = lotId(lotIndex);
    plates[lot] = (regInput?.value || "").trim();
  }

  // expose to inline onclick
  window.nextLot = function nextLot() {
    persistCurrentLotInput();
    if (lotIndex < totalLots) lotIndex++;
    renderLot();
    beep();
    vibrate();
  };

  window.prevLot = function prevLot() {
    persistCurrentLotInput();
    if (lotIndex > 1) lotIndex--;
    renderLot();
    beep();
    vibrate();
  };

  if (regInput) {
    regInput.addEventListener("input", () => {
      regInput.value = normalizePlate(regInput.value);
      const lot = lotId(lotIndex);
      plates[lot] = regInput.value.trim();
      renderSlot(lot);
    });
  }

  /* Swipe kiri/kanan (same behavior) */
  let touchStartX = 0;
  document.addEventListener("touchstart", (e) => {
    touchStartX = e.changedTouches[0].screenX;
  }, { passive: true });

  document.addEventListener("touchend", (e) => {
    const dx = e.changedTouches[0].screenX - touchStartX;
    if (Math.abs(dx) > 60) (dx < 0) ? window.nextLot() : window.prevLot();
  }, { passive: true });

  /* =========================
     ZONE SELECT + GRID VISIBILITY
  ========================= */
  function applyZone(key) {
    if (!ZONES[key]) return;

    persistCurrentLotInput();

    zoneKey = key;
    totalLots = (ZONES[zoneKey].end - ZONES[zoneKey].start + 1);
    lotIndex = 1;

    buildGrid();
    renderAllSlots();
    renderLot();
  }

  function updateGridVisibility() {
    if (!gvLiveBox) return;
    const v = zoneSelect ? zoneSelect.value : "";
    gvLiveBox.style.display = v ? "block" : "none";

    if (!v) {
      if (gvTitle) gvTitle.textContent = "PARKING LIST";
      renderLotPlaceholder();
      return;
    }

    // zone selected
    setInputsEnabled(true);
  }

  if (zoneSelect) {
    // start in -PLEASE SELECT-
    zoneSelect.value = "";
    updateGridVisibility();

    zoneSelect.addEventListener("change", () => {
      applyZone(zoneSelect.value);
      updateGridVisibility();
    });
  }

  /* =========================
     GRID POPUP (Sensory style)
  ========================= */
  function openGridPopup(lot) {
    const current = (plates[lot] || "").trim();

    safeSwalFire({
      title: lot,
      html: `
        <span class="sw-reg-label">REG NUM</span>
        <input id="swRegInput" class="sw-reg-input" value="${current}" autocomplete="off" inputmode="text" />
      `,
      showCancelButton: true,
      confirmButtonText: "OK",
      cancelButtonText: "NO",
      reverseButtons: true,
      background: "linear-gradient(135deg, #e9f7ef 0%, #c8efd9 45%, #9fdfbf 100%)",
      color: "#176B39",
      width: 300,
      customClass: { popup: "vpms-swal" },
      willOpen: (popup) => { popup.style.borderRadius = "14px"; },
      didOpen: () => {
        const el = document.getElementById("swRegInput");
        if (!el) return;

        el.addEventListener("input", () => { el.value = normalizePlate(el.value); });
        el.focus();

        // move caret to end
        try { el.setSelectionRange(el.value.length, el.value.length); } catch (_) {}
      },
      preConfirm: () => {
        const el = document.getElementById("swRegInput");
        return el ? normalizePlate(el.value).trim() : "";
      }
    }).then((r) => {
      if (!r || !r.isConfirmed) return;
      plates[lot] = (r.value || "").trim();
      renderSlot(lot);
      setActiveLot(lot);
      beep();
      vibrate();
    });
  }

  // keep global availability (if other code calls it)
  window.openGridPopup = openGridPopup;

  /* =========================
     SUBMIT (BATCH) — keep behavior
  ========================= */
  window.submitAll = async function submitAll() {
    const round = roundSelect ? roundSelect.value : "";
    if (!round) {
      if (statusBox) {
        statusBox.innerHTML = "⚠️ PLEASE SELECT ROUND TIME";
        statusBox.style.color = "red";
      }
      return;
    }
    if (zoneSelect && !zoneSelect.value) {
      if (statusBox) {
        statusBox.innerHTML = "⚠️ PLEASE SELECT PARKING LIST";
        statusBox.style.color = "red";
      }
      return;
    }

    persistCurrentLotInput();

    const items = [];
    for (let i = 1; i <= totalLots; i++) {
      const lot = lotId(i);
      const plate = (plates[lot] || "").trim();
      if (plate) items.push({ round, lot, plate });
    }

    if (items.length === 0) {
      if (statusBox) {
        statusBox.innerHTML = "⚠️ NO REG NUM FILLED";
        statusBox.style.color = "red";
      }
      return;
    }

    if (statusBox) {
      statusBox.innerHTML = `⏳ SUBMITTING ${items.length} LOTS...`;
      statusBox.style.color = "#333";
    }

    try {
      const res = await fetch(WORKER_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ batch: true, items })
      });

      const data = await res.json();
      if (!data.ok) throw new Error(data.message || "Submit failed");

      if (statusBox) {
        statusBox.innerHTML =
          `✅ SAVED ${data.saved} LOTS<br>` +
          `FREE: ${data.summary?.free ?? 0} | CHARGED: ${data.summary?.charged ?? 0}`;
        statusBox.style.color = "green";
      }

      beep();
      vibrate();

      // keep existing behavior: clear current zone lots only, keep selected zone
      for (let i = 1; i <= totalLots; i++) plates[lotId(i)] = "";
      lotIndex = 1;
      renderLot();
      renderAllSlots();

    } catch (_) {
      if (statusBox) {
        statusBox.innerHTML = "❌ ERROR SUBMITTING DATA";
        statusBox.style.color = "red";
      }
    }
  };

  /* =========================
     FIXED HEADER OFFSET
  ========================= */
  (function fixedHeaderOffset() {
    let raf = null;
    const sync = () => {
      const header = document.querySelector(".fixed-header");
      if (!header) return;
      const height = header.offsetHeight || 0;
      document.body.style.paddingTop = height + "px";
    };
    const schedule = () => {
      if (raf) cancelAnimationFrame(raf);
      raf = requestAnimationFrame(sync);
    };
    window.addEventListener("load", schedule);
    window.addEventListener("resize", schedule);
    window.addEventListener("orientationchange", schedule);
    document.addEventListener("DOMContentLoaded", schedule);

    if (document.fonts && document.fonts.ready) {
      document.fonts.ready.then(schedule).catch(() => {});
    }
  })();

  /* =========================
     INIT
  ========================= */
  totalLots = (ZONES[zoneKey].end - ZONES[zoneKey].start + 1);
  buildGrid();
  renderAllSlots();
  updateGridVisibility();
  if (zoneSelect && zoneSelect.value) renderLot();
  else renderLotPlaceholder();
})();
</script>

</body>
</html>
